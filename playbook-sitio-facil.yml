---
- name: "ğŸŒ Sitio Web SÃºper FÃ¡cil - Â¡Solo Python!"
  hosts: localhost
  gather_facts: yes
  vars:
    puerto: "9999"
    directorio: "/var/tmp/sitio-facil"
  
  tasks:
    - name: "ğŸ¯ Crear directorio del sitio"
      file:
        path: "{{ directorio }}"
        state: directory
        mode: '0755'

    - name: "ğŸ“„ Crear pÃ¡gina web principal"
      copy:
        dest: "{{ directorio }}/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="es">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ğŸš€ Sitio Web desde AWX</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      background: linear-gradient(45deg, #667eea, #764ba2);
                      margin: 0;
                      padding: 0;
                      min-height: 100vh;
                      display: flex;
                      justify-content: center;
                      align-items: center;
                  }
                  .container {
                      background: white;
                      padding: 40px;
                      border-radius: 20px;
                      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                      text-align: center;
                      max-width: 600px;
                  }
                  h1 {
                      color: #333;
                      font-size: 3em;
                      margin-bottom: 20px;
                      animation: bounce 2s infinite;
                  }
                  @keyframes bounce {
                      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                      40% { transform: translateY(-30px); }
                      60% { transform: translateY(-15px); }
                  }
                  .success {
                      background: #28a745;
                      color: white;
                      padding: 15px;
                      border-radius: 10px;
                      margin: 20px 0;
                      font-size: 1.2em;
                  }
                  .info {
                      background: #17a2b8;
                      color: white;
                      padding: 15px;
                      border-radius: 10px;
                      margin: 20px 0;
                  }
                  .btn {
                      background: linear-gradient(45deg, #667eea, #764ba2);
                      color: white;
                      padding: 15px 30px;
                      border: none;
                      border-radius: 25px;
                      font-size: 1.1em;
                      cursor: pointer;
                      margin: 10px;
                      transition: transform 0.3s;
                  }
                  .btn:hover {
                      transform: translateY(-3px);
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸš€ Â¡FUNCIONA!</h1>
                  
                  <div class="success">
                      âœ… Sitio web ejecutÃ¡ndose desde AWX
                  </div>
                  
                  <div class="info">
                      <strong>ğŸ TecnologÃ­a:</strong> Python HTTP Server<br>
                      <strong>ğŸŒ Puerto:</strong> {{ puerto }}<br>
                      <strong>ğŸ“… Fecha:</strong> {{ ansible_date_time.date }}<br>
                      <strong>â° Hora:</strong> {{ ansible_date_time.time }}
                  </div>
                  
                  <h2>ğŸ‰ Â¡Lo logramos!</h2>
                  <p>Este sitio web estÃ¡ corriendo dentro del contenedor AWX usando solo Python estÃ¡ndar.</p>
                  
                  <button class="btn" onclick="alert('Â¡Hola desde AWX! ğŸš€')">
                      ğŸ¯ Hacer Click
                  </button>
                  
                  <button class="btn" onclick="location.reload()">
                      ğŸ”„ Refrescar
                  </button>
                  
                  <div style="margin-top: 30px; color: #666;">
                      <small>Generado por Ansible en AWX</small>
                  </div>
              </div>
              
              <script>
                  // Efecto visual cada 5 segundos
                  setInterval(function() {
                      document.body.style.background = 
                          'linear-gradient(45deg, #' + 
                          Math.floor(Math.random()*16777215).toString(16) + ', #' +
                          Math.floor(Math.random()*16777215).toString(16) + ')';
                  }, 5000);
              </script>
          </body>
          </html>

    - name: "ğŸš€ Crear servidor web simple"
      copy:
        dest: "{{ directorio }}/servidor.py"
        mode: '0755'
        content: |
          #!/usr/bin/env python3
          import http.server
          import socketserver
          import os
          from datetime import datetime
          
          PORT = {{ puerto }}
          DIRECTORY = "{{ directorio }}"
          
          class SimpleHandler(http.server.SimpleHTTPRequestHandler):
              def __init__(self, *args, **kwargs):
                  super().__init__(*args, directory=DIRECTORY, **kwargs)
              
              def log_message(self, format, *args):
                  print(f"[{datetime.now().strftime('%H:%M:%S')}] {format % args}")
          
          print(f"ğŸš€ Iniciando servidor web...")
          print(f"ğŸ“ Directorio: {DIRECTORY}")
          print(f"ğŸŒ Puerto: {PORT}")
          print(f"ğŸ”— URL: http://localhost:{PORT}")
          
          try:
              with socketserver.TCPServer(("", PORT), SimpleHandler) as httpd:
                  print(f"âœ… Servidor corriendo en puerto {PORT}")
                  print("ğŸ”„ Presiona Ctrl+C para detener")
                  httpd.serve_forever()
          except Exception as e:
              print(f"âŒ Error: {e}")

    - name: "ğŸŒ Iniciar servidor web en background"
      shell: |
        cd {{ directorio }}
        python3 servidor.py > servidor.log 2>&1 &
        echo $! > servidor.pid
        sleep 2
        if kill -0 $(cat servidor.pid) 2>/dev/null; then
          echo "âœ… Servidor iniciado correctamente"
        else
          echo "âŒ Error iniciando servidor"
          exit 1
        fi
      register: inicio_servidor

    - name: "â³ Verificar que el puerto estÃ© abierto"
      wait_for:
        port: "{{ puerto }}"
        host: "127.0.0.1"
        delay: 1
        timeout: 10
      register: puerto_check

    - name: "ğŸ¥ Test del sitio web"
      uri:
        url: "http://127.0.0.1:{{ puerto }}"
        method: GET
        timeout: 5
      register: web_test
      ignore_errors: yes

    - name: "ğŸ“Š Verificar proceso"
      shell: |
        cd {{ directorio }}
        if [ -f servidor.pid ]; then
          PID=$(cat servidor.pid)
          if kill -0 $PID 2>/dev/null; then
            echo "âœ… Proceso corriendo (PID: $PID)"
          else
            echo "âŒ Proceso no encontrado"
          fi
        fi
      register: proceso_check
      changed_when: false

    - name: "ğŸ‰ Â¡SITIO WEB LISTO!"
      debug:
        msg:
          - "================================"
          - "ğŸŒ SITIO WEB FUNCIONANDO"
          - "================================"
          - "âœ… Estado: {{ 'ONLINE' if web_test.status == 200 else 'OFFLINE' }}"
          - "ğŸŒ Puerto: {{ puerto }}"
          - "ğŸ“ Directorio: {{ directorio }}"
          - "================================"
          - "ğŸš€ PARA ACCEDER:"
          - "kubectl port-forward -n awx deployment/awx-local-task {{ puerto }}:{{ puerto }}"
          - "Luego abrir: http://localhost:{{ puerto }}"
          - "================================"
          - "ğŸ¯ Â¡SÃšPER FÃCIL Y FUNCIONANDO!"
          - "================================"

    - name: "ğŸ“‹ InformaciÃ³n adicional"
      debug:
        msg:
          - "ğŸ“Š Proceso: {{ proceso_check.stdout }}"
          - "ğŸŒ Web Test: {{ 'OK' if web_test.status == 200 else 'FAIL' }}"
          - "âš¡ Inicio: {{ inicio_servidor.stdout }}" 