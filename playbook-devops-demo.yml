---
- name: "ğŸš€ DevOps Pipeline Demo - VersiÃ³n para AWX sin kubectl"
  hosts: localhost
  gather_facts: yes
  vars:
    # ğŸ¨ ConfiguraciÃ³n del Pipeline
    pipeline_name: "devops-pipeline-demo"
    environment: "{{ env | default('staging') }}"
    deployment_strategy: "{{ strategy | default('blue-green') }}"
    
    # ğŸ—ï¸ AplicaciÃ³n Demo
    app_name: "flask-monitoring-app"
    app_version: "{{ app_name }}:v{{ ansible_date_time.epoch }}"
    
    # ğŸ“Š Features
    monitoring_enabled: "{{ monitoring | default(true) }}"
    security_scan_enabled: "{{ security | default(true) }}"
    chaos_enabled: "{{ chaos | default(false) }}"
    
    # ğŸ¯ ConfiguraciÃ³n
    app_namespace: "{{ app_name }}-{{ environment }}"
    replicas: "{{ app_replicas | default(3) }}"

  tasks:
    - name: "ğŸ­ Banner Ã‰pico del Pipeline Demo"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                ğŸš€ DEVOPS PIPELINE DEMO ğŸš€                   â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  Pipeline:     {{ pipeline_name }}                          â•‘"
          - "â•‘  Environment:  {{ environment }}                            â•‘"
          - "â•‘  Strategy:     {{ deployment_strategy }}                    â•‘"
          - "â•‘  App:          {{ app_name }}                               â•‘"
          - "â•‘  Version:      {{ app_version }}                            â•‘"
          - "â•‘  Namespace:    {{ app_namespace }}                          â•‘"
          - "â•‘  Replicas:     {{ replicas }}                               â•‘"
          - "â•‘  Timestamp:    {{ ansible_date_time.iso8601 }}              â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    # ğŸ—ï¸ FASE 1: ENVIRONMENT SETUP
    - name: "ğŸ—ï¸ FASE 1: Environment Setup"
      debug:
        msg: 
          - "ğŸ”§ Configurando entorno {{ environment }}"
          - "ğŸ“¦ Namespace: {{ app_namespace }}"
          - "ğŸ¯ Strategy: {{ deployment_strategy }}"

    - name: "ğŸ“¦ Simulando creaciÃ³n de namespace"
      debug:
        msg: "âœ… Namespace '{{ app_namespace }}' creado exitosamente"

    - name: "ğŸ·ï¸ Aplicando etiquetas de entorno"
      debug:
        msg:
          - "ğŸ·ï¸ Etiquetas aplicadas:"
          - "  - environment: {{ environment }}"
          - "  - pipeline: {{ pipeline_name }}"
          - "  - managed-by: awx"

    # ğŸ”¨ FASE 2: BUILD & SECURITY
    - name: "ğŸ”¨ FASE 2: Build & Security Scan"
      debug:
        msg: "Iniciando build y security scanning"

    - name: "ğŸ—ï¸ Building application"
      debug:
        msg:
          - "ğŸ”¨ Building {{ app_name }}..."
          - "ğŸ“¦ Image: {{ app_version }}"
          - "ğŸ—ï¸ Build iniciado: {{ ansible_date_time.time }}"

    - name: "â³ Simulando tiempo de build"
      pause:
        seconds: 3

    - name: "âœ… Build completado"
      debug:
        msg: "ğŸ‰ Build exitoso: {{ app_version }}"

    - name: "ğŸ›¡ï¸ Security Scan"
      debug:
        msg: "ğŸ” Ejecutando security scan..."
      when: security_scan_enabled

    - name: "ğŸ” Ejecutando escaneo de vulnerabilidades"
      debug:
        msg:
          - "ğŸ›¡ï¸ Security Scan Results:"
          - "  âœ… Dockerfile security check: PASSED"
          - "  âœ… Dependency scan: PASSED (0 vulnerabilities)"
          - "  âœ… Static code analysis: PASSED"
          - "  âœ… Container image scan: PASSED"
          - "  ğŸ”’ Security Score: 9.8/10"
      when: security_scan_enabled

    # ğŸš€ FASE 3: DEPLOYMENT SIMULATION
    - name: "ğŸš€ FASE 3: Deployment Simulation"
      debug:
        msg: "Iniciando deployment usando estrategia {{ deployment_strategy }}"

    - name: "ğŸ”µ Blue-Green Deployment"
      debug:
        msg:
          - "ğŸ”µ BLUE DEPLOYMENT:"
          - "  ğŸ“¦ Deploying {{ app_name }}-blue"
          - "  ğŸ”¢ Replicas: {{ replicas }}"
          - "  ğŸŒ Service: {{ app_name }}-service"
          - "  ğŸ¯ Strategy: {{ deployment_strategy }}"
      when: deployment_strategy == "blue-green"

    - name: "â³ Simulando deployment"
      pause:
        seconds: 5

    - name: "âœ… Deployment exitoso"
      debug:
        msg:
          - "ğŸ‰ Deployment completado exitosamente!"
          - "ğŸ”µ Blue version: ACTIVE"
          - "ğŸŒ Service endpoint: http://{{ app_name }}-service:80"
          - "ğŸ“Š Health check: PASSED"

    # ğŸ“Š FASE 4: MONITORING SETUP
    - name: "ğŸ“Š FASE 4: Monitoring Setup"
      debug:
        msg: "Configurando monitoring y observabilidad"
      when: monitoring_enabled

    - name: "ğŸ“ˆ Prometheus Setup"
      debug:
        msg:
          - "ğŸ“ˆ Configurando Prometheus..."
          - "ğŸ¯ Targets: {{ app_name }} pods"
          - "ğŸ“Š Metrics: http_requests_total, response_time"
          - "ğŸ”” Alertas: error_rate > 5%, latency > 500ms"
      when: monitoring_enabled

    - name: "ğŸ“Š Grafana Dashboard"
      debug:
        msg:
          - "ğŸ“Š Configurando Grafana dashboard..."
          - "ğŸ“ˆ Panels: Request Rate, Error Rate, Latency"
          - "ğŸ¨ Dashboard: '{{ app_name }} Monitoring'"
          - "ğŸ”” Alertas configuradas"
      when: monitoring_enabled

    # ğŸ§ª FASE 5: TESTING
    - name: "ğŸ§ª FASE 5: Automated Testing"
      debug:
        msg: "Ejecutando baterÃ­a de tests automatizados"

    - name: "ğŸ¥ Health Check"
      debug:
        msg:
          - "ğŸ¥ Health Check Results:"
          - "  âœ… Liveness probe: PASSED"
          - "  âœ… Readiness probe: PASSED"
          - "  âœ… Startup probe: PASSED"
          - "  ğŸŒ¡ï¸ CPU usage: 45%"
          - "  ğŸ’¾ Memory usage: 120MB"

    - name: "ğŸ§ª Load Testing"
      debug:
        msg:
          - "ğŸ§ª Load Test Results:"
          - "  ğŸ“Š Total requests: 1000"
          - "  âœ… Successful: 995 (99.5%)"
          - "  âŒ Failed: 5 (0.5%)"
          - "  â±ï¸ Avg response time: 85ms"
          - "  ğŸ“ˆ P95 latency: 150ms"
          - "  ğŸ¯ Throughput: 120 RPS"

    - name: "ğŸ›¡ï¸ Security Testing"
      debug:
        msg:
          - "ğŸ›¡ï¸ Security Test Results:"
          - "  âœ… OWASP Top 10: PASSED"
          - "  âœ… SQL Injection: PASSED"
          - "  âœ… XSS Prevention: PASSED"
          - "  âœ… Authentication: PASSED"
          - "  âœ… Authorization: PASSED"
      when: security_scan_enabled

    # ğŸ’¥ FASE 6: CHAOS ENGINEERING
    - name: "ğŸ’¥ FASE 6: Chaos Engineering"
      debug:
        msg: "Ejecutando experimentos de Chaos Engineering"
      when: chaos_enabled

    - name: "ğŸ’ Chaos Monkey Simulation"
      debug:
        msg:
          - "ğŸ’ Chaos Monkey Experiments:"
          - "  ğŸ’¥ Pod failure: SIMULATED"
          - "  ğŸŒ Network latency: SIMULATED"
          - "  ğŸ’¾ Memory pressure: SIMULATED"
          - "  ğŸ“Š System resilience: VERIFIED"
          - "  ğŸ”„ Auto-recovery: SUCCESSFUL"
      when: chaos_enabled

    # ğŸ”„ FASE 7: CANARY DEPLOYMENT
    - name: "ğŸ”„ FASE 7: Canary Deployment"
      debug:
        msg: "Preparando Canary deployment"
      when: deployment_strategy == "canary"

    - name: "ğŸŸ¢ Green Deployment (Canary)"
      debug:
        msg:
          - "ğŸŸ¢ GREEN DEPLOYMENT (CANARY):"
          - "  ğŸ“¦ Version: {{ app_version }}-canary"
          - "  ğŸ¯ Traffic split: 10% canary, 90% stable"
          - "  ğŸ“Š Monitoring: ACTIVE"
          - "  â±ï¸ Duration: 5 minutes"
      when: deployment_strategy == "canary"

    - name: "ğŸ“Š Canary Metrics Evaluation"
      debug:
        msg:
          - "ğŸ“Š Canary Analysis:"
          - "  ğŸ“ˆ Error rate: 0.8% (GOOD)"
          - "  â±ï¸ Latency P95: 95ms (GOOD)"
          - "  ğŸ¯ Success rate: 99.2% (GOOD)"
          - "  âœ… Decision: PROMOTE CANARY"
      when: deployment_strategy == "canary"

    # ğŸ‰ FASE 8: DEPLOYMENT COMPLETION
    - name: "ğŸ‰ FASE 8: Deployment Completion"
      debug:
        msg: "Finalizando deployment y configuraciÃ³n"

    - name: "ğŸ”„ Traffic Routing"
      debug:
        msg:
          - "ğŸ”„ Configurando traffic routing:"
          - "  ğŸ¯ Primary: {{ app_name }}-blue (100%)"
          - "  ğŸŒ Load balancer: CONFIGURED"
          - "  ğŸ“Š Health checks: ENABLED"

    - name: "ğŸ“¦ Scaling Configuration"
      debug:
        msg:
          - "ğŸ“¦ Auto-scaling configurado:"
          - "  ğŸ“Š Min replicas: 2"
          - "  ğŸ“ˆ Max replicas: 10"
          - "  ğŸ¯ Target CPU: 70%"
          - "  ğŸ’¾ Target Memory: 80%"

    # ğŸ‰ REPORTE FINAL
    - name: "ğŸ‰ REPORTE FINAL DEL PIPELINE"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    ğŸ‰ PIPELINE COMPLETADO ğŸ‰                â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘  ğŸ“Š RESUMEN DEL DEPLOYMENT:                                  â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  ğŸš€ AplicaciÃ³n:    {{ app_name }}                           â•‘"
          - "â•‘  ğŸŒ Environment:   {{ environment }}                        â•‘"
          - "â•‘  ğŸ“¦ Version:       {{ app_version }}                        â•‘"
          - "â•‘  ğŸ¯ Strategy:      {{ deployment_strategy }}               â•‘"
          - "â•‘  ğŸ“Š Replicas:      {{ replicas }}                          â•‘"
          - "â•‘  âœ… Status:        DEPLOYED & HEALTHY                       â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  ğŸ¯ CARACTERÃSTICAS ACTIVADAS:                               â•‘"
          - "â•‘  ğŸ“Š Monitoring:    {{ 'ENABLED' if monitoring_enabled else 'DISABLED' }}                              â•‘"
          - "â•‘  ğŸ›¡ï¸ Security:      {{ 'ENABLED' if security_scan_enabled else 'DISABLED' }}                           â•‘"
          - "â•‘  ğŸ’¥ Chaos:         {{ 'ENABLED' if chaos_enabled else 'DISABLED' }}                                   â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  ğŸ“‹ MÃ‰TRICAS FINALES:                                        â•‘"
          - "â•‘  âœ… Success Rate:  99.5%                                     â•‘"
          - "â•‘  â±ï¸ Avg Latency:   85ms                                      â•‘"
          - "â•‘  ğŸ¯ Throughput:    120 RPS                                   â•‘"
          - "â•‘  ğŸ”’ Security:      9.8/10                                    â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: "ğŸš€ PrÃ³ximos Pasos y Comandos"
      debug:
        msg:
          - "ğŸ¯ PRÃ“XIMOS PASOS:"
          - ""
          - "1. ğŸ”„ Para ejecutar Canary deployment:"
          - "   Variables: strategy=canary"
          - ""
          - "2. ğŸ’¥ Para activar Chaos Engineering:"
          - "   Variables: chaos=true"
          - ""
          - "3. ğŸŒ Para deployment en producciÃ³n:"
          - "   Variables: env=production, app_replicas=5"
          - ""
          - "4. ğŸ›¡ï¸ Para desactivar security scan:"
          - "   Variables: security=false"
          - ""
          - "5. ğŸ“Š Para desactivar monitoring:"
          - "   Variables: monitoring=false"
          - ""
          - "ğŸ® EXPERIMENTOS SUGERIDOS:"
          - "â€¢ Cambiar strategy a 'canary'"
          - "â€¢ Incrementar replicas a 5"
          - "â€¢ Activar chaos engineering"
          - "â€¢ Probar con environment 'production'" 