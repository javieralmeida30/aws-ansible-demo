---
- name: "ğŸŒ Test Servidor Web SIMPLE"
  hosts: localhost
  gather_facts: no
  vars:
    puerto: "7777"
    
  tasks:
    - name: "ğŸ¯ InformaciÃ³n"
      debug:
        msg:
          - "ğŸš€ Iniciando servidor web simple"
          - "ğŸŒ Puerto: {{ puerto }}"
          - "â° DuraciÃ³n: 30 segundos"

    - name: "ğŸŒ Servidor Web Python - VERSIÃ“N SIMPLE"
      shell: |
        python3 -c "
        import http.server
        import socketserver
        import threading
        import time
        
        PORT = {{ puerto }}
        
        class Handler(http.server.BaseHTTPRequestHandler):
            def do_GET(self):
                self.send_response(200)
                self.send_header('Content-type', 'text/html')
                self.end_headers()
                html = '''
                <!DOCTYPE html>
                <html>
                <head>
                    <title>FUNCIONA!</title>
                    <style>
                        body { 
                            font-family: Arial; 
                            text-align: center; 
                            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                            color: white;
                            padding: 50px;
                        }
                        h1 { font-size: 4em; animation: bounce 1s infinite; }
                        @keyframes bounce {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-20px); }
                        }
                    </style>
                </head>
                <body>
                    <h1>ğŸš€ Â¡FUNCIONA!</h1>
                    <h2>âœ… Servidor desde AWX</h2>
                    <p>Puerto: {{ puerto }}</p>
                    <p>ğŸ‰ Â¡Lo logramos!</p>
                </body>
                </html>
                '''
                self.wfile.write(html.encode())
            
            def log_message(self, format, *args):
                pass
        
        print('ğŸš€ Servidor iniciando...')
        try:
            with socketserver.TCPServer(('', PORT), Handler) as httpd:
                print(f'âœ… Servidor ACTIVO en puerto {PORT}')
                
                def stop_server():
                    time.sleep(30)
                    httpd.shutdown()
                
                threading.Thread(target=stop_server, daemon=True).start()
                httpd.serve_forever()
                
        except Exception as e:
            print(f'âŒ Error: {e}')
        
        print('â° Servidor terminado')
        " &
        
        echo "ğŸ”„ Esperando 2 segundos..."
        sleep 2
        
        # Verificar si el servidor estÃ¡ corriendo
        if netstat -tln 2>/dev/null | grep :{{ puerto }} >/dev/null; then
          echo "âœ… Puerto {{ puerto }} ABIERTO"
        else
          echo "âŒ Puerto {{ puerto }} NO disponible"
        fi
        
        echo "ğŸ¯ Servidor lanzado en background"
      register: servidor_output

    - name: "ğŸ“Š Resultado del servidor"
      debug:
        msg: "{{ servidor_output.stdout_lines }}"

    - name: "â³ Verificar puerto"
      wait_for:
        port: "{{ puerto }}"
        host: "127.0.0.1"
        delay: 1
        timeout: 5
      ignore_errors: yes
      register: puerto_check

    - name: "ğŸ‰ RESULTADO"
      debug:
        msg:
          - "================================"
          - "ğŸŒ SERVIDOR WEB TEST"
          - "================================"
          - "Puerto {{ puerto }}: {{ 'ABIERTO âœ…' if puerto_check is succeeded else 'CERRADO âŒ' }}"
          - "================================"
          - "ğŸš€ PARA ACCEDER:"
          - "kubectl port-forward -n awx deployment/awx-local-task {{ puerto }}:{{ puerto }}"
          - "http://localhost:{{ puerto }}"
          - "================================"
          - "â° Servidor activo por 30 segundos"
          - "================================"

    - name: "â³ Mantener playbook activo 30 segundos"
      pause:
        seconds: 30
        prompt: "ğŸŒ Servidor activo - Accede a http://localhost:{{ puerto }} (port-forward en otra terminal)"

    - name: "âœ… Completado"
      debug:
        msg: "ï¿½ï¿½ Test completado" 