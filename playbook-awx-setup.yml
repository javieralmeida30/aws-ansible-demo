---
- name: "ğŸ”§ AWX Environment Setup - PreparaciÃ³n del entorno"
  hosts: localhost
  gather_facts: yes
  become: false
  vars:
    kubectl_version: "v1.28.0"
    kubectl_path: "/tmp/kubectl"

  tasks:
    - name: "ğŸ­ Banner Setup AWX"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    ğŸ”§ AWX ENVIRONMENT SETUP ğŸ”§               â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  Preparando entorno para ejecutar playbooks DevOps          â•‘"
          - "â•‘  Instalando kubectl y dependencias necesarias               â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: "ğŸ“‹ Verificar sistema operativo"
      debug:
        msg: 
          - "Sistema: {{ ansible_system }}"
          - "Arquitectura: {{ ansible_architecture }}"
          - "DistribuciÃ³n: {{ ansible_distribution | default('Unknown') }}"

    - name: "ğŸ” Verificar si kubectl ya existe"
      stat:
        path: "{{ kubectl_path }}"
      register: kubectl_exists

    - name: "ğŸ“¥ Descargar kubectl si no existe"
      get_url:
        url: "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        dest: "{{ kubectl_path }}"
        mode: '0755'
        timeout: 30
      when: not kubectl_exists.stat.exists
      register: kubectl_download
      ignore_errors: yes

    - name: "ğŸ”§ Descargar kubectl alternativo (mÃ©todo 2)"
      shell: |
        curl -LO "https://dl.k8s.io/release/{{ kubectl_version }}/bin/linux/amd64/kubectl"
        chmod +x kubectl
        mv kubectl {{ kubectl_path }}
      when: not kubectl_exists.stat.exists and kubectl_download is failed
      ignore_errors: yes

    - name: "âœ… Verificar instalaciÃ³n kubectl"
      shell: "{{ kubectl_path }} version --client --output=yaml"
      register: kubectl_check
      ignore_errors: yes

    - name: "ğŸ“Š Estado kubectl"
      debug:
        msg: "{{ kubectl_check.stdout if kubectl_check is succeeded else 'kubectl no disponible - modo simulaciÃ³n activado' }}"

    - name: "ğŸ” Verificar conexiÃ³n a Kubernetes"
      shell: "{{ kubectl_path }} cluster-info"
      register: k8s_connection
      ignore_errors: yes

    - name: "ğŸ“Š Estado conexiÃ³n Kubernetes"
      debug:
        msg: "{{ k8s_connection.stdout_lines if k8s_connection is succeeded else ['Kubernetes no accesible desde AWX', 'Se ejecutarÃ¡ en modo simulaciÃ³n'] }}"

    - name: "ğŸ“¦ Instalar herramientas Python necesarias"
      pip:
        name:
          - requests
          - urllib3
          - kubernetes
        state: present
      ignore_errors: yes

    - name: "ğŸ¯ Crear directorio de trabajo"
      file:
        path: /tmp/awx-devops
        state: directory
        mode: '0755'

    - name: "ğŸ“ Crear script de utilidades"
      copy:
        dest: "/tmp/awx-devops/utils.sh"
        mode: '0755'
        content: |
          #!/bin/bash
          
          # Utilidades para AWX DevOps
          KUBECTL_PATH="{{ kubectl_path }}"
          
          # FunciÃ³n para verificar kubectl
          check_kubectl() {
              if [ -f "$KUBECTL_PATH" ]; then
                  echo "âœ… kubectl disponible en $KUBECTL_PATH"
                  return 0
              else
                  echo "âŒ kubectl no disponible"
                  return 1
              fi
          }
          
          # FunciÃ³n para verificar conexiÃ³n k8s
          check_k8s() {
              if $KUBECTL_PATH cluster-info > /dev/null 2>&1; then
                  echo "âœ… ConexiÃ³n a Kubernetes OK"
                  return 0
              else
                  echo "âŒ Sin conexiÃ³n a Kubernetes"
                  return 1
              fi
          }
          
          # FunciÃ³n simulaciÃ³n kubectl
          simulate_kubectl() {
              echo "ğŸ­ MODO SIMULACIÃ“N - kubectl $@"
              case "$1" in
                  "create")
                      echo "namespace/$3 created (simulated)"
                      ;;
                  "apply")
                      echo "deployment.apps/test-app created (simulated)"
                      echo "service/test-service created (simulated)"
                      ;;
                  "get")
                      if [[ "$2" == "pods" ]]; then
                          echo "NAME          READY   STATUS    RESTARTS   AGE"
                          echo "test-pod-1    1/1     Running   0          30s"
                          echo "test-pod-2    1/1     Running   0          30s"
                      fi
                      ;;
                  *)
                      echo "Command simulated successfully"
                      ;;
              esac
          }

    - name: "ğŸ‰ Reporte de Setup"
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    ğŸ‰ SETUP COMPLETADO ğŸ‰                   â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘  ğŸ“Š ESTADO DEL ENTORNO:                                      â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  ğŸ”§ kubectl:       {{ 'DISPONIBLE' if kubectl_check is succeeded else 'NO DISPONIBLE' }}                             â•‘"
          - "â•‘  ğŸŒ Kubernetes:    {{ 'CONECTADO' if k8s_connection is succeeded else 'NO CONECTADO' }}                              â•‘"
          - "â•‘  ğŸ“ kubectl path:  {{ kubectl_path }}                       â•‘"
          - "â•‘                                                              â•‘"
          - "â•‘  ğŸ“‹ SIGUIENTE PASO:                                          â•‘"
          - "â•‘  Ejecutar los playbooks DevOps con las variables correctas  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: "ğŸ”§ Comandos de troubleshooting"
      debug:
        msg:
          - "ğŸ› ï¸ TROUBLESHOOTING:"
          - ""
          - "# Verificar kubectl manual:"
          - "{{ kubectl_path }} version --client"
          - ""
          - "# Verificar conexiÃ³n k8s:"
          - "{{ kubectl_path }} cluster-info"
          - ""
          - "# Ejecutar utilidades:"
          - "bash /tmp/awx-devops/utils.sh" 